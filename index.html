<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>نظام تتبع الشحنات - بوابة العميل</title>
    <link rel="stylesheet" href="css/style.css">
</head>
<body>

    <div id="login-page" class="page active">
        <div class="login-container">
            <h2>تسجيل دخول العملاء</h2>
            <form id="login-form">
                <div class="form-group">
                    <label for="email">البريد الإلكتروني:</label>
                    <input type="email" id="email" required>
                </div>
                <div class="form-group">
                    <label for="password">كلمة المرور:</label>
                    <input type="password" id="password" required>
                </div>
                <button type="button" id="login-button">دخول</button>
                <p id="error-message" class="error-text"></p>
            </form>
        </div>
    </div>

    <div id="dashboard-page" class="page hidden">
        <header>
            <h1 id="welcome-user-text">لوحة التحكم الرئيسية</h1>
            <button id="logout-button">تسجيل خروج</button>
        </header>
        <main>
            <section id="status-summary"></section>
            <section id="shipment-list">
                <h2>شحناتي النشطة</h2>
                <button id="go-to-create-shipment">إنشاء شحنة جديدة</button>
                <table id="shipments-table"></table>
            </section>
        </main>
    </div>

    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>

    <script>
        // 1. بيانات إعداد مشروعك
        const firebaseConfig = {
          apiKey: "AIzaSyCIjIjs-2nhLrtssISWc0pNuX2UzxhQ3ZE",
          authDomain: "shipping-tracker-pro.firebaseapp.com",
          projectId: "shipping-tracker-pro",
          storageBucket: "shipping-tracker-pro.firebasestorage.app",
          messagingSenderId: "188119609466",
          appId: "1:188119609466:web:2f2498def75deb9905cbc3",
          measurementId: "G-6V51EXWFMJ"
        };

        // 2. تهيئة التطبيق
        const app = firebase.initializeApp(firebaseConfig);
        
        // تعريف المتغيرات العالمية (V8)
        window.auth = firebase.auth(); 
        window.onAuthStateChanged = firebase.auth().onAuthStateChanged.bind(firebase.auth());
        window.signInWithEmailAndPassword = firebase.auth().signInWithEmailAndPassword.bind(firebase.auth());
        window.signOut = firebase.auth().signOut.bind(firebase.auth());
    </script>


    <script>
        // دالة التعامل مع تسجيل الدخول
        async function handleLogin(email, password) {
            // نستخدم المتغيرات العالمية
            const signInService = window.signInWithEmailAndPassword;

            const errorMessageElement = document.getElementById('error-message');
            if (errorMessageElement) {
                errorMessageElement.textContent = ''; 
                errorMessageElement.style.display = 'none';
            }

            // التحقق الأولي: إذا كانت الحقول فارغة، أظهر رسالة وتوقف
            if (!email || !password) {
                let message = "الرجاء إدخال البريد الإلكتروني وكلمة المرور.";
                if (errorMessageElement) {
                    errorMessageElement.textContent = `فشل الدخول: ${message}`;
                    errorMessageElement.style.display = 'block';
                }
                return; 
            }

            try {
                // محاولة تسجيل الدخول - تم إزالة authService
                await signInService(email, password); 

            } catch (error) {
                console.error("خطأ في تسجيل الدخول:", error.message);
                let message = "حدث خطأ غير معروف في تسجيل الدخول.";
                if (error.code === 'auth/user-not-found' || error.code === 'auth/wrong-password') {
                    message = "البريد الإلكتروني أو كلمة المرور غير صحيحة.";
                } else if (error.code === 'auth/invalid-email') {
                    message = "صيغة البريد الإلكتروني غير صحيحة.";
                } else if (error.code === 'auth/too-many-requests') {
                    message = "تم حظر هذا الحساب مؤقتاً. الرجاء المحاولة لاحقاً.";
                }

                if (errorMessageElement) {
                    errorMessageElement.textContent = `فشل الدخول: ${message}`;
                    errorMessageElement.style.display = 'block';
                }
            }
        }

        // دالة تسجيل الخروج
        async function logoutUser() {
            const signOutService = window.signOut;
            
            try {
                // تم إزالة authService
                await signOutService();
            } catch (error) {
                console.error("خطأ في تسجيل الخروج:", error.message);
                alert("فشل تسجيل الخروج.");
            }
        }

        // الدوال المدمجة من js/app.js 
        function navigateTo(pageId) {
            document.querySelectorAll('.page').forEach(page => {
                page.classList.remove('active');
                page.classList.add('hidden');
            });

            const targetPage = document.getElementById(pageId);
            if (targetPage) {
                targetPage.classList.remove('hidden');
                targetPage.classList.add('active');
            }
        }

        function updateDashboardUI(user) {
            const welcomeText = document.getElementById('welcome-user-text');
            if (welcomeText && user) {
                const email = user.email || "مستخدم";
                welcomeText.textContent = `مرحباً بك، ${email}`;
            }
        }

        // وظيفة التهيئة الرئيسية
        document.addEventListener('DOMContentLoaded', () => {
            const loginButton = document.getElementById('login-button');
            if (loginButton) {
                loginButton.addEventListener('click', () => {
                    const email = document.getElementById('email').value;
                    const password = document.getElementById('password').value;
                    handleLogin(email, password); 
                });
            }

            const logoutButton = document.getElementById('logout-button');
            if (logoutButton) {
                logoutButton.addEventListener('click', logoutUser);
            }

            const createShipmentBtn = document.getElementById('go-to-create-shipment');
            if (createShipmentBtn) createShipmentBtn.addEventListener('click', () => navigateTo('create-shipment-page'));

            const dashboardBtn = document.getElementById('go-to-dashboard');
            if (dashboardBtn) dashboardBtn.addEventListener('click', () => navigateTo('dashboard-page'));

            // مراقبة حالة المستخدم
            const authStateChanged = window.onAuthStateChanged;

            // تم إزالة authService كمعامل
            authStateChanged((user) => {
                if (user) {
                    console.log("المستخدم مسجل الدخول:", user.uid);
                    updateDashboardUI(user);
                    navigateTo('dashboard-page');
                } else {
                    console.log("المستخدم غير مسجل.");
                    navigateTo('login-page');
                }
            });
        });
    </script>
    
</body>
</html>
